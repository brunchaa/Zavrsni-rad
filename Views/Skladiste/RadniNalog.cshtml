@model SkladisteRobe.Models.BulkTransactionViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Radni nalog";
}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<div class="container my-5">
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white rounded-top p-4">
            <h2 class="mb-0">Radni nalog</h2>
        </div>
        <div class="card-body p-4">
            @Html.ValidationSummary(true, "", new { @class = "text-danger alert alert-danger mb-4" })
            <form asp-controller="Skladiste" asp-action="RadniNalog" method="post" id="bulkForm">
                @Html.AntiForgeryToken()
                <div id="itemsContainer">
                    <div class="bulk-item mb-4 p-3 border rounded bg-light" data-index="0">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Naziv materijala</label>
                                <input type="text" name="Items[0].Naziv" class="form-control naziv-autocomplete" required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Količina</label>
                                <input type="number" name="Items[0].Kolicina" class="form-control" required min="1" placeholder="1" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Mjerna jedinica</label>
                                <select name="Items[0].Jedinica" class="form-select" required>
                                    <option value="">Odaberi...</option>
                                    <option value="KOMAD">KOMAD</option>
                                    <option value="METAR">METAR</option>
                                    <option value="m2">m2</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger w-100 removeItemBtn"><i class="fas fa-trash"></i> Ukloni</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-start mb-4">
                    <button type="button" id="addItemBtn" class="btn btn-secondary me-2"><i class="fas fa-plus"></i> Dodaj stavku ručno</button>
                    <button type="button" id="scanSkenerBtn" class="btn btn-info me-2"><i class="fas fa-barcode"></i> Skeniraj skenerom</button>
                </div>
                <!-- Skriveni input za sken -->
                <input type="text" id="hiddenBarcodeInput" style="position: absolute; left: -9999px;" />
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" id="submitPrimka" class="btn btn-success me-md-2"><i class="fas fa-arrow-down"></i> Primka</button>
                    <button type="button" id="submitIzdaj" class="btn btn-warning"><i class="fas fa-arrow-up"></i> Izdaj robu</button>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://unpkg.com/@@zxing/library@@latest"></script>

    <script>
        let itemIndex = 1;
        let isScanActive = false;
        let scanTimeout = null;
        let currentScan = '';
        // Funkcija za update remove buttona: Sakrij ako samo jedan item
        function updateRemoveButtons() {
            const items = document.querySelectorAll('.bulk-item');
            const removeBtns = document.querySelectorAll('.removeItemBtn');
            if (items.length <= 1) {
                removeBtns.forEach(btn => btn.style.display = 'none');
            } else {
                removeBtns.forEach(btn => btn.style.display = 'block');
            }
        }
        // Dodaj stavku ručno
        document.getElementById('addItemBtn').addEventListener('click', function () {
            const container = document.getElementById('itemsContainer');
            const div = document.createElement('div');
            div.classList.add('bulk-item', 'mb-4', 'p-3', 'border', 'rounded', 'bg-light');
            div.setAttribute('data-index', itemIndex);
            div.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Naziv materijala</label>
                        <input type="text" name="Items[${itemIndex}].Naziv" class="form-control naziv-autocomplete" required placeholder="Unesite naziv" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Količina</label>
                        <input type="number" name="Items[${itemIndex}].Kolicina" class="form-control" required min="1" placeholder="1" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Mjerna jedinica</label>
                        <select name="Items[${itemIndex}].Jedinica" class="form-select" required>
                            <option value="">Odaberi...</option>
                            <option value="KOMAD">KOMAD</option>
                            <option value="METAR">METAR</option>
                            <option value="m2">m2</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger w-100 removeItemBtn"><i class="fas fa-trash"></i> Ukloni</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            itemIndex++;
            updateRemoveButtons();
        });
        // Dodaj/popuni stavku iz skena: Prvo popuni prazan ako postoji, inače dodaj novi
        function addScannedItem(scannedData) {
            const container = document.getElementById('itemsContainer');
            const items = container.querySelectorAll('.bulk-item');
            let filled = false;
            // Traži prvi prazan item (naziv empty)
            items.forEach(item => {
                if (filled) return;
                const nazivInput = item.querySelector('input[name$=".Naziv"]');
                if (nazivInput && nazivInput.value.trim() === '') {
                    nazivInput.value = scannedData.naziv;
                    const kolicinaInput = item.querySelector('input[name$=".Kolicina"]');
                    if (kolicinaInput) kolicinaInput.value = 1;
                    const jedinicaSelect = item.querySelector('select[name$=".Jedinica"]');
                    if (jedinicaSelect && scannedData.jedinica) {
                        jedinicaSelect.value = scannedData.jedinica;
                    }
                    filled = true;
                }
            });
            // Ako nije popunio nijedan, dodaj novi
            if (!filled) {
                const div = document.createElement('div');
                div.classList.add('bulk-item', 'mb-4', 'p-3', 'border', 'rounded', 'bg-light');
                div.setAttribute('data-index', itemIndex);
                div.innerHTML = `
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Naziv materijala</label>
                            <input type="text" name="Items[${itemIndex}].Naziv" value="${scannedData.naziv}" class="form-control naziv-autocomplete" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Količina</label>
                            <input type="number" name="Items[${itemIndex}].Kolicina" value="1" class="form-control" required min="1" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Mjerna jedinica</label>
                            <select name="Items[${itemIndex}].Jedinica" class="form-select" required>
                                <option value="">Odaberi...</option>
                                <option value="KOMAD">KOMAD</option>
                                <option value="METAR">METAR</option>
                                <option value="m2">m2</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger w-100 removeItemBtn"><i class="fas fa-trash"></i> Ukloni</button>
                        </div>
                    </div>
                `;
                const jedinicaSelect = div.querySelector('select[name$=".Jedinica"]');
                if (scannedData.jedinica) {
                    jedinicaSelect.value = scannedData.jedinica;
                }
                container.appendChild(div);
                itemIndex++;
            }
            updateRemoveButtons();
        }
        // Obrada skena
        function processScan(barcodeData) {
            barcodeData = barcodeData.replace(/\s/g, ''); // Ukloni sve space i novi red
            console.log('Očišćeni podatak: "' + barcodeData + '"'); // Debug
            // Koristi regex da izvučeš brojeve nakon 'MaterijalId:'
            const matches = barcodeData.match(/MaterijalId:(\d+)/g) || [];
            const barkodovi = matches.map(match => match.replace('MaterijalId:', ''));
            console.log('Izvučeni ID-ovi: ', barkodovi); // Debug
            if (barkodovi.length === 0) {
                console.warn('Nema valjanih ID-ova u skenu.');
                return;
            }
            barkodovi.forEach(idStr => {
                const id = parseInt(idStr);
                if (isNaN(id)) {
                    console.warn('Preskačem nevaljani ID: ' + idStr);
                    alert('Upozorenje: Nevaljani ID pronađen (dobiven: ' + idStr + '). Preskačem.');
                    return;
                }
                console.log('Dohvaćam materijal za ID: ' + id); // Debug
                $.get('/Skladiste/GetMaterijal?id=' + id, function (data) {
                    if (data.success) {
                        addScannedItem({ naziv: data.naziv, jedinica: data.jedinica });
                    } else {
                        alert('Greška: Materijal nije pronađen za ID: ' + id);
                    }
                }).fail(function () {
                    alert('Greška u dohvaćanju materijala za ID: ' + id);
                });
            });
        }
        // Toggle skeniranja
        document.getElementById('scanSkenerBtn').addEventListener('click', function () {
            isScanActive = !isScanActive;
            const btn = this;
            if (isScanActive) {
                btn.classList.remove('btn-info');
                btn.classList.add('btn-danger');
                btn.innerHTML = '<i class="fas fa-barcode"></i> Skeniranje aktivno (klikni za stop)';
                document.getElementById('hiddenBarcodeInput').focus();
            } else {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-info');
                btn.innerHTML = '<i class="fas fa-barcode"></i> Skeniraj skenerom';
                document.activeElement.blur();
            }
        });
        // Input event za skener sa debounce timeoutom
        document.getElementById('hiddenBarcodeInput').addEventListener('input', (event) => {
            if (!isScanActive) return;
            currentScan = event.target.value;
            console.log('Trenutni input: ' + currentScan); // Debug za praćenje
            if (scanTimeout) clearTimeout(scanTimeout);
            scanTimeout = setTimeout(() => {
                if (currentScan) {
                    console.log('Processing scan after pause: ' + currentScan); // Debug
                    processScan(currentScan);
                    event.target.value = '';
                    currentScan = '';
                }
            }, 100); // Čekaj 100ms pauze da smatraš sken završenim
        });
        // AUTOCOMPLETE
        $(document).on('focus', '.naziv-autocomplete', function () {
            $(this).autocomplete({
                source: function (request, response) {
                    $.get("/Skladiste/SearchMaterijali?term=" + request.term, function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.naziv + " (" + item.jedinica + ")",
                                value: item.naziv,
                                jedinica: item.jedinica
                            };
                        }));
                    });
                },
                select: function (event, ui) {
                    $(this).val(ui.item.value);
                    var jedinicaSelect = $(this).closest('.bulk-item').find('select[name$=".Jedinica"]');
                    if (jedinicaSelect.length > 0) {
                        jedinicaSelect.val(ui.item.jedinica);
                    }
                    return false;
                }
            });
        });
        // AJAX submit za Primka i Izdaj robu
        $('#submitPrimka').click(function () {
            submitForm('Primka');
        });
        $('#submitIzdaj').click(function () {
            submitForm('Izdaj robu');
        });
        function submitForm(submitType) {
            var form = $('#bulkForm');
            var formData = new FormData(form[0]);
            formData.append('submitType', submitType);
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function () {
                    var xhr = new XMLHttpRequest();
                    xhr.responseType = 'blob';
                    return xhr;
                },
                success: function (blob, status, xhr) {
                    var contentDisposition = xhr.getResponseHeader('Content-Disposition');
                    var fileName = contentDisposition.split('filename=')[1].replace(/"/g, '');
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    location.reload();
                },
                error: function (xhr, status, error) {
                    alert('Greška: ' + error);
                }
            });
        }
        // Inicijalno update i event delegation za remove button-e
        document.addEventListener('DOMContentLoaded', function () {
            updateRemoveButtons();
            // Event delegation za sve remove button-e (hvata i prvi i dinamičke)
            document.getElementById('itemsContainer').addEventListener('click', function (event) {
                if (event.target.closest('.removeItemBtn')) {
                    const btn = event.target.closest('.removeItemBtn');
                    const item = btn.closest('.bulk-item');
                    if (item) {
                        item.remove();
                        updateRemoveButtons();
                    }
                }
            });
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}