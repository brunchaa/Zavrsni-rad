@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Radni nalog";
}

<div class="container my-5">
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white rounded-top p-4">
            <h2 class="mb-0">Radni nalog</h2>
        </div>
        <div class="card-body p-4">
            @Html.ValidationSummary(true, "", new { @class = "text-danger alert alert-danger mb-4" })

            <form asp-controller="Skladiste" asp-action="RadniNalog" method="post" id="bulkForm">
                <div id="itemsContainer">
                    <!-- Default prva stavka -->
                    <div class="bulk-item mb-4 p-3 border rounded bg-light" data-index="0">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Naziv materijala</label>
                                <input type="text" name="Items[0].Naziv" class="form-control" required placeholder="Unesite naziv" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Količina</label>
                                <input type="number" name="Items[0].Kolicina" class="form-control" required min="1" placeholder="1" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Mjerna jedinica</label>
                                <select name="Items[0].Jedinica" class="form-select" required>
                                    <option value="">Odaberi...</option>
                                    <option value="KOMAD">KOMAD</option>
                                    <option value="METAR">METAR</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger w-100 removeItemBtn" style="display: none;"><i class="fas fa-trash"></i> Ukloni</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-start mb-4">
                    <button type="button" id="addItemBtn" class="btn btn-secondary me-2"><i class="fas fa-plus"></i> Dodaj stavku ručno</button>
                    <button type="button" id="scanSkenerBtn" class="btn btn-info me-2"><i class="fas fa-barcode"></i> Skeniraj skenerom</button>
                    <button type="button" id="scanCameraBtn" class="btn btn-info"><i class="fas fa-camera"></i> Skeniraj kamerom</button>
                </div>

                <!-- Sekcija za skeniranje skenerom (skrivena) -->
                <div id="skenerSection" style="display: none; margin-bottom: 20px;">
                    <h4>Skeniraj fizičkim skenerom</h4>
                    <p>Stisni gumb na skeneru i usmjeri ga na barkod – broj će se upisati ovdje. Možeš skenirati više puta bez ponovnog klika gumba.</p>
                    <input type="text" id="barcodeInput" class="form-control" placeholder="Stisni gumb na skeneru..." autofocus />
                    <div id="resultScanner" class="mt-2 alert alert-info"></div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="document.getElementById('skenerSection').style.display = 'none';">Zatvori</button>
                </div>

                <!-- Sekcija za skeniranje kamerom (skrivena) -->
                <div id="cameraSection" style="display: none; margin-bottom: 20px;">
                    <h4>Skeniraj kamerom</h4>
                    <p>Drži barkod ispred kamere – app će ga pročitati automatski. Možeš skenirati više puta dok sekcija otvorena.</p>
                    <video id="videoElementId" width="400" height="300" autoplay style="border: 1px solid black;"></video>
                    <div id="resultCamera" class="mt-2 alert alert-info"></div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="document.getElementById('cameraSection').style.display = 'none'; if (codeReader) codeReader.reset();">Zatvori</button>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" name="submitType" value="Primka" class="btn btn-success me-md-2"><i class="fas fa-arrow-down"></i> Primka</button>
                    <button type="submit" name="submitType" value="Izdaj robu" class="btn btn-warning"><i class="fas fa-arrow-up"></i> Izdaj robe</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/@@zxing/library@@latest"></script>

    <script>
        let itemIndex = 1;
        let codeReader = null;  // Za kameru

        // Dodaj stavku ručno (zadržano)
        document.getElementById('addItemBtn').addEventListener('click', function () {
            // ... (isti kod kao prije za dodavanje ručne stavke, kopiraj iz prethodnog ako treba)
        });

        // Funkcija za dodavanje stavke iz skena
        function addScannedItem(barcodeData) {
            // ... (isti kod kao prije za dodavanje stavke, prilagodi naziv/količina/jedinica ako imaš GetMaterijal)
        }

        // Obrada skena i slanje na server
        function processScan(barcodeData) {
            // ... (isti kod kao prije za fetch /Barcode/ProcessScan)
        }

        // Skeniraj skenerom - pokaži sekciju i fokusiraj input
        document.getElementById('scanSkenerBtn').addEventListener('click', function () {
            const skenerSection = document.getElementById('skenerSection');
            skenerSection.style.display = 'block';
            document.getElementById('barcodeInput').focus();
            document.getElementById('cameraSection').style.display = 'none';
        });

        // Skeniraj kamerom - pokaži sekciju i startaj kameru
        document.getElementById('scanCameraBtn').addEventListener('click', function () {
            const cameraSection = document.getElementById('cameraSection');
            cameraSection.style.display = 'block';
            document.getElementById('skenerSection').style.display = 'none';
            startCameraScan();
        });

        // Start camera scan
        function startCameraScan() {
            codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoDevice(null, 'videoElementId', (result, err) => {
                if (result) {
                    document.getElementById('resultCamera').innerText = 'Skenirano: ' + result.text;
                    processScan(result.text);
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err);
                }
            });
        }

        // Obrada inputa od skenera
        document.getElementById('barcodeInput').addEventListener('input', (event) => {
            let input = event.target.value.trim();
            if (input) {
                document.getElementById('resultScanner').innerText = 'Skenirano: ' + input;
                processScan(input);
                event.target.value = '';  // Reset za sljedeći sken
            }
        });

        // ... (ostali JS za addItemBtn i remove ako ih imaš)
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}