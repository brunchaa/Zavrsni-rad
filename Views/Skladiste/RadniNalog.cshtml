@model SkladisteRobe.Models.BulkTransactionViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Radni nalog";
}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css"> i <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<div class="container my-5">
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white rounded-top p-4">
            <h2 class="mb-0">Radni nalog</h2>
        </div>
        <div class="card-body p-4">
            @Html.ValidationSummary(true, "", new { @class = "text-danger alert alert-danger mb-4" })

            <form asp-controller="Skladiste" asp-action="RadniNalog" method="post" id="bulkForm">
                <div id="itemsContainer">
                    <div class="bulk-item mb-4 p-3 border rounded bg-light" data-index="0">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Naziv materijala</label>
                                <input type="text" name="Items[0].Naziv" class="form-control naziv-autocomplete" required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Količina</label>
                                <input type="number" name="Items[0].Kolicina" class="form-control" required min="1" placeholder="1" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Mjerna jedinica</label>
                                <select name="Items[0].Jedinica" class="form-select" required>
                                    <option value="">Odaberi...</option>
                                    <option value="KOMAD">KOMAD</option>
                                    <option value="METAR">METAR</option>
                                    <option value="m2">m2</option>  // Dodano m2
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger w-100 removeItemBtn" style="display: none;"><i class="fas fa-trash"></i> Ukloni</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-start mb-4">
                    <button type="button" id="addItemBtn" class="btn btn-secondary me-2"><i class="fas fa-plus"></i> Dodaj stavku ručno</button>
                    <button type="button" id="scanSkenerBtn" class="btn btn-info me-2"><i class="fas fa-barcode"></i> Skeniraj skenerom</button>
                    <button type="button" id="scanCameraBtn" class="btn btn-info"><i class="fas fa-camera"></i> Skeniraj kamerom</button>
                </div>

                <div id="skenerSection" style="display: none; margin-bottom: 20px;">
                    <h4>Skeniraj fizičkim skenerom</h4>
                    <input type="text" id="barcodeInput" class="form-control" placeholder="Skeniraj ovdje..." autofocus />
                    <div id="resultScanner" class="mt-2"></div>
                </div>

                <div id="cameraSection" style="display: none; margin-bottom: 20px;">
                    <h4>Skeniraj kamerom</h4>
                    <video id="videoElementId" width="400" height="300" autoplay></video>
                    <div id="resultCamera" class="mt-2"></div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" name="submitType" value="Primka" class="btn btn-success me-md-2"><i class="fas fa-arrow-down"></i> Primka</button>
                    <button type="submit" name="submitType" value="Izdaj robu" class="btn btn-warning"><i class="fas fa-arrow-up"></i> Izdaj robu</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/@@zxing/library@@latest"></script>

    <script>
        let itemIndex = 1;

        // Dodaj stavku ručno
        document.getElementById('addItemBtn').addEventListener('click', function () {
            const container = document.getElementById('itemsContainer');
            const div = document.createElement('div');
            div.classList.add('bulk-item', 'mb-4', 'p-3', 'border', 'rounded', 'bg-light');
            div.setAttribute('data-index', itemIndex);
            div.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Naziv materijala</label>
                        <input type="text" name="Items[${itemIndex}].Naziv" class="form-control" required placeholder="Unesite naziv" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Količina</label>
                        <input type="number" name="Items[${itemIndex}].Kolicina" class="form-control" required min="1" placeholder="1" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Mjerna jedinica</label>
                        <select name="Items[${itemIndex}].Jedinica" class="form-select" required>
                            <option value="">Odaberi...</option>
                            <option value="KOMAD">KOMAD</option>
                            <option value="METAR">METAR</option>
                            <option value="m2">m2</option>  // Dodano m2
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger w-100 removeItemBtn"><i class="fas fa-trash"></i> Ukloni</button>
                    </div>
                </div>
            `;
            div.querySelector('.removeItemBtn').addEventListener('click', function () {
                container.removeChild(div);
            });
            container.appendChild(div);
            itemIndex++;
        });

        // Funkcija za dodavanje stavke iz skena
        function addScannedItem(barcodeData) {
            const container = document.getElementById('itemsContainer');
            const div = document.createElement('div');
            div.classList.add('bulk-item', 'mb-4', 'p-3', 'border', 'rounded', 'bg-light');
            div.setAttribute('data-index', itemIndex);
            div.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Naziv materijala</label>
                        <input type="text" name="Items[${itemIndex}].Naziv" value="${barcodeData}" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Količina</label>
                        <input type="number" name="Items[${itemIndex}].Kolicina" value="1" class="form-control" required min="1" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Mjerna jedinica</label>
                        <select name="Items[${itemIndex}].Jedinica" class="form-select" required>
                            <option value="">Odaberi...</option>
                            <option value="KOMAD">KOMAD</option>
                            <option value="METAR">METAR</option>
                            <option value="m2">m2</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger w-100 removeItemBtn"><i class="fas fa-trash"></i> Ukloni</button>
                    </div>
                </div>
            `;
            div.querySelector('.removeItemBtn').addEventListener('click', function () {
                container.removeChild(div);
            });
            container.appendChild(div);
            itemIndex++;
        }

        // Funkcija za obradu skena i slanje na server
        function processScan(barcodeData) {
            var tip = document.querySelector('[name="submitType"]').value == 'Primka' ? 'ulaz' : 'izlaz';
            fetch('/Barcode/ProcessScan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ barcodeData: barcodeData, tip: tip })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Transakcija dodana! ID: ' + data.transakcijaId);
                      addScannedItem(barcodeData);  // Dodaj stavku sa barcodeData (prilagoditi sa nazivom iz data ako controller vrati)
                  } else {
                      alert('Greška: ' + data.message);
                  }
              }).catch(error => {
                  alert('Greška: ' + error);
              });
        }

        // Skeniraj skenerom - pokaži sekciju i fokusiraj input
        document.getElementById('scanSkenerBtn').addEventListener('click', function () {
            document.getElementById('skenerSection').style.display = 'block';
            document.getElementById('barcodeInput').focus();
            document.getElementById('cameraSection').style.display = 'none';
        });

        // Skeniraj kamerom - pokaži sekciju i startaj kameru
        document.getElementById('scanCameraBtn').addEventListener('click', function () {
            document.getElementById('cameraSection').style.display = 'block';
            document.getElementById('skenerSection').style.display = 'none';
            startCameraScan();
        });

        // Zatvori skener sekciju
        document.getElementById('closeSkenerBtn').addEventListener('click', function () {
            document.getElementById('skenerSection').style.display = 'none';
        });

        // Zatvori camera sekciju i stop kameru
        document.getElementById('closeCameraBtn').addEventListener('click', function () {
            document.getElementById('cameraSection').style.display = 'none';
            if (codeReader) codeReader.reset();
        });

        // Start camera scan
        function startCameraScan() {
            codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoDevice(null, 'videoElementId', (result, err) => {
                if (result) {
                    document.getElementById('resultCamera').innerText = 'Skenirano: ' + result.text;
                    processScan(result.text);
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err);
                }
            });
        }

        // Obrada inputa od skenera
        document.getElementById('barcodeInput').addEventListener('input', (event) => {
            let input = event.target.value.trim();
            if (input) {
                document.getElementById('resultScanner').innerText = 'Skenirano: ' + input;
                processScan(input);
                event.target.value = '';  // Reset za sljedeći sken
            }
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css">

    <script>
        $(document).on('focus', '.naziv-autocomplete', function () {
            $(this).autocomplete({
                source: function (request, response) {
                    $.get("/Skladiste/SearchMaterijali?term=" + request.term, function (data) {
                        response($.map(data, function (item) {
                            return { label: item.label + " (" + item.jedinica + ")", value: item.label, jedinica: item.jedinica };
                        }));
                    });
                },
                select: function (event, ui) {
                    $(this).val(ui.item.value);
                    $(this).closest('.bulk-item').find('select[name$=".Jedinica"]').val(ui.item.jedinica);
                    return false;
                }
            });
        });
    </script>
}