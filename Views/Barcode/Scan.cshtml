@{
    ViewData["Title"] = "Skeniraj Barkod";
    int radniNalogId = ViewBag.RadniNalogId;
}

<h1>Skeniraj Barkod za Radni Nalog @radniNalogId</h1>

<!--  Skeniranje kamerom -->
<div>
    <h3>Skeniraj kamerom</h3>
    <video id="videoElementId" width="400" height="300" autoplay></video>
    <div id="resultCamera"></div>
</div>

<!--  Skeniranje fizičkim barkod skenerom -->
<div style="margin-top: 20px;">
    <h3>Skeniraj fizičkim skenerom</h3>
    <input type="text" id="barcodeInput" placeholder="Skeniraj ovdje..." autofocus />
    <div id="resultScanner"></div>
</div>

@section Scripts {
    <script src="https://unpkg.com/@@zxing/library@@latest"></script>
    <script>
        // Funkcija za slanje na server
        function sendToProcessScan(barcodeData, tip) {
            fetch('/Barcode/ProcessScan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ barcodeData: barcodeData, tip: '@ViewBag.Tip' })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Transakcija dodana! ID: ' + data.transakcijaId);
                      //  Reset input ili reload
                  } else {
                      alert('Greška: ' + data.message);
                  }
              }).catch(error => {
                  alert('Greška u komunikaciji: ' + error);
              });
        }

        // Skeniranje kamerom
        const codeReader = new ZXing.BrowserMultiFormatReader();
        codeReader.decodeFromVideoDevice(null, 'videoElementId', (result, err) => {
            if (result) {
                document.getElementById('resultCamera').innerText = 'Skenirano kamerom: ' + result.text;
                sendToProcessScan(result.text, '@ViewBag.Tip');
                codeReader.reset(); // Stop kamera nakon skena
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error(err);
            }
        });

        // Skeniranje fizičkim skenerom
        document.getElementById('barcodeInput').addEventListener('input', (event) => {
            let input = event.target.value.trim();
            if (input) {
                document.getElementById('resultScanner').innerText = 'Skenirano skenerom: ' + input;
                sendToProcessScan(input, '@ViewBag.Tip');
                event.target.value = ''; // Reset input za sljedeći sken
            }
        });
    </script>
}